<div class="card">
    <div class="stepper-scroll-wrapper">
      <p-steps 
        *ngIf="stepItems.length > 0"
        [model]="stepItems" 
        [readonly]="false" 
        [(activeIndex)]="activeIndex" 
        (onChange)="onStepChange($event)">
      </p-steps>
    </div>
  </div>
  
  <div class="card"  *ngIf="selectedSection && selectedSection?.nom === 'Contact'"> 
  <h4 class="mb-5 font-bold">Audit Contact</h4>
  <form *ngIf="createAuditForm" [formGroup]="createAuditForm"> 
      <div class="p-fluid p-formgrid">
          <div class="grid">
              <div class="field col-12">
                  <label>Client</label>
                  <input pInputText type="text" formControlName="client" /> 
              </div>  
              <div class="field col-12">
                  <label>Auditors</label>
                  <p-chips formControlName="auditors"/> 
              </div>    
              <div class="field col-12 md:col-12">
                  <label>Organisation name</label>
                  <input pInputText type="text" formControlName="organisationName"/>
              </div>
              <div class="col-12 md:col-6">
                  <label>Contract number</label>
                  <input pInputText type="text" formControlName="contactNumber"/>
              </div>
              <div class="col-12 md:col-6">
                  <label>Phone number</label>
                  <input pInputText type="text" formControlName="phoneNumber"/>
              </div>                  
              <div class="field col-12">
                  <label>Website</label>
                  <input pInputText type="text" formControlName="website"/>
              </div>
              <div class="field col-12 md:col-6">
                  <label>Employees number</label>
                  <input pInputText type="number" min="0" formControlName="employeesNumber"/>
              </div>
              <div class="field col-12 md:col-6">
                  <label>Employees number in the perimeter</label>
                  <input pInputText type="number" min="0" formControlName="employeesInPerimeter"/>
              </div>
          </div>
          <br>
          <div class="grid">
              <div class="field col-12 md:col-6">
                  <label>Contact name</label>
                  <input pInputText type="text" formControlName="contactName"/>
              </div>
              <div class="field col-12 md:col-6">
                  <label>Contact email</label>
                  <input pInputText type="text" formControlName="contactEmail"/>
              </div>
          </div>
      </div>
  </form>
</div>
  
  
  <!-- Affichage du questionnaire si la section sÃ©lectionnÃ©e est "Questionnaire" -->
  <div class="card" *ngIf="selectedSection?.nom === 'Questionnaire'">
      <h5 class="font-bold">Questionnaire</h5>
      <p-divider/>
  
      <ul class="list-none p-0 m-0">
          <li class="flex flex-column md:flex-row md:align-items-center md:justify-content-between px-3 py-1" *ngFor="let q of questions">
              <div>
                  <div class="mt-1 text-400">{{ q.question?.category }} 
                      <span *ngIf="q.question?.subcategory">- {{ q.question?.subcategory }}</span>
                  </div>
                  <span class="text-900 font-medium mr-2 mb-1 md:mb-0">{{ q.question?.question }}</span>
              </div>
              <div class="mt-2 md:mt-0 flex align-items-center gap-2">
                  <p-button 
                      icon="pi pi-check" 
                      severity="success" 
                      [rounded]="true" 
                      [text]="q.response !== 'true'" >
                  </p-button>
                  <p-button 
                      icon="pi pi-times" 
                      severity="danger" 
                      [rounded]="true" 
                      [text]="q.response !== 'false'" >
                  </p-button>
              </div>
          </li> 
          <p-divider/>
      </ul>
  </div>  
  
  <!-- Affichage des Ã©quipements si la section sÃ©lectionnÃ©e est "Infrastructure" -->
  <div class="card" *ngIf="selectedSection?.nom === 'Infrastructure'">
    <div class="grid justify-content-between col">
        <div>
            <h4 class="mb-5 font-bold">Audit Equipements</h4>
        </div>
    </div>
    <div *ngIf="rawEquipements.length != 0">
        <div class="grid p-fluid">
            <div class="col-12" [ngClass]="{'md:col-12' : !selectedEquipement,'md:col-5' : selectedEquipement }">
              <p-accordion>
                <p-accordionTab *ngFor="let key of getKeys(groupedEquipements)">
                  <ng-template pTemplate="header">
                    <span class="flex align-items-center gap-2 w-full" style="word-break: break-all;">
                      <span class="font-bold">{{ key }}</span>
                      <p-badge [value]="groupedEquipements[key].length" class="ml-auto mr-2" />
                    </span>
                  </ng-template>
              
                  <!-- ðŸ”¹ Affichage des Ã©quipements de chaque catÃ©gorie -->
                  <div class="flex flex-column" *ngFor="let item of groupedEquipements[key]; let i = index">
                    <div class="flex gap-1 justify-content-between">
                      <p-button [text]="true" icon="pi pi-eye"  
                        [label]="item.category + ' ' + item.ref" severity="secondary"
                        (click)="handleEquipementShow(item)" />
                    </div>
                  </div>
                </p-accordionTab>
              </p-accordion>
              
            </div>
            <div class="col-12 md:col-7" *ngIf="selectedEquipement"> 
                <div class="card p-3 shadow-sm">
                    <div class="flex justify-content-between align-items-center text-sm">
                        <h6 class="text-900 font-semibold">Category</h6>
                        <span class="text-900 font-semibold">{{ selectedEquipement.category }}</span>
                    </div>
                    <p-divider />
            
                    <div class="flex justify-content-between align-items-center text-sm">
                        <h6 class="text-900 font-semibold">Sub category</h6>
                        <span class="text-900 font-semibold">{{ selectedEquipement.subcategory }}</span>
                    </div>
                    <p-divider />
            
                    <div class="flex justify-content-between align-items-center text-sm">
                        <h6 class="text-900 font-semibold">Manufacturer</h6>
                        <span class="text-900 font-semibold">{{ selectedEquipement.manufacturer }}</span>
                    </div>
                    <p-divider />
            
                    <div class="flex justify-content-between align-items-center text-sm">
                        <h6 class="text-900 font-semibold">Reference</h6>
                        <span class="text-900 font-semibold">{{ selectedEquipement.ref }}</span>
                    </div>
                    <p-divider />
            
                    <div class="flex justify-content-between align-items-center text-sm">
                        <h6 class="text-900 font-semibold">Details</h6>
                        <span class="text-900 font-semibold">{{ selectedEquipement.details }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="rawEquipements.length == 0" class="p-fluid mb-5">
        <div class="card">
            <h5 class="mb-0 text-center">No equipement selected yet</h5>   
        </div>       
    </div>
  </div>
  
  
  <div class="card" *ngIf="selectedSection?.nom === 'Files'"> 
    <h4 class="font-bold">Files</h4>
    <p-divider/>

    <p-table [value]="filteredFiles" [rows]="10" [loading]="loading" [rowHover]="true" 
        styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
        
        <!-- âœ… Barre de recherche + Reload -->
        <ng-template pTemplate="caption">
            <div class="flex justify-content-end flex-column sm:flex-row">
               <span class="p-input-icon-left mb-2">
                   <i class="pi pi-search"></i>
                   <input pInputText type="text"(input)="handleSearch($event.target.value)" placeholder="Search Keyword" class="w-full"/>
               </span>
               <p-button label="Reload" [loading]="loading" (onClick)="fetchFiles()" class="mx-2"></p-button>
           </div>
        </ng-template>

        <!-- âœ… Table Header -->
        <ng-template pTemplate="header">
            <tr>
                <th style="min-width: 12rem">File Name</th>      
            </tr>
        </ng-template>

        <!-- âœ… Table Body -->
        <ng-template pTemplate="body" let-file>
            <tr>
                <td>
                    <div *ngIf="files.length > 0; else noFiles">
                        <ul class="list-none p-0">
                            <li *ngFor="let file of files" class="p-2 border-bottom flex align-items-center gap-3">
                            <i class="pi pi-file text-blue-500 text-xl"></i>
                            <span class="font-bold flex-1">{{ file.title }}</span>
                            <p-button 
                                label="Open" 
                                icon="pi pi-external-link" 
                                severity="primary" 
                                (click)="openFile(file.title)">
                            </p-button>      
                            </li>
                        </ul>
                    </div>
                </td>
            </tr>
        </ng-template>

        <!-- âœ… Message quand il n'y a pas de fichiers -->
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="8" class="text-center text-gray-600">No File found.</td>
            </tr>
        </ng-template>

        <!-- âœ… Message de chargement -->
        <ng-template pTemplate="loadingbody">
            <tr>
                <td colspan="8" class="text-center text-gray-600">Loading files ... Please wait.</td>
            </tr>
        </ng-template>
    </p-table>
</div>

  
  
 <!-- Affichage des autres sections -->
<div class="card" 
*ngIf="selectedSection && selectedSection.nom !== 'Questionnaire' && selectedSection.nom !== 'Infrastructure' && selectedSection.nom !== 'Contact' && selectedSection.nom !== 'Files'">

<h4 class="font-bold">{{ selectedSection.nom }}</h4>
<p-divider />

<form>
<div class="p-fluid">
 <ul class="list-none p-0 m-0">
   <li *ngFor="let champ of selectedSection.champs" class="field col-12 mb-3">
     <label class="text-900 font-medium block mb-2">{{ champ.label }}</label>

     <!-- Inputs simples dÃ©sactivÃ©s -->
     <input 
       *ngIf="champ.type === 'text' || champ.type === 'email' || champ.type === 'number' || champ.type === 'date'" 
       class="p-inputtext w-full" 
       pInputText 
       [type]="champ.type" 
       [(ngModel)]="champ.value" 
       [name]="champ.label" 
       disabled />

     <!-- Textarea dÃ©sactivÃ©e -->
     <textarea 
       *ngIf="champ.type === 'textarea'" 
       class="p-inputtext w-full" 
       rows="3"
       [(ngModel)]="champ.value" 
       [name]="champ.label" 
       disabled>
     </textarea>

     <!-- Champ tableau avec inputs dÃ©sactivÃ©s -->
     <div *ngIf="champ.type === 'array'" class="flex flex-column gap-2">
       <input 
         *ngFor="let item of champ.value; let i = index" 
         type="text" 
         class="p-inputtext w-full" 
         [value]="item" 
         [name]="champ.label + '_' + i" 
         disabled />
     </div>
   </li>
 </ul>
</div>
</form>

</div>


    <!-- âœ… Champ "Remark" -->
    <div class="card" *ngIf="selectedSection?.status !== 'rejected' && selectedSection?.nom !=='Contact'">
        <div class="mt-4">
            <label class="font-bold">Remark</label>
            <textarea 
                pInputTextarea 
                [(ngModel)]="remark"
                class="p-inputtextarea w-full text-black font-medium" 
                rows="4">
            </textarea>
        </div>
    
        <div class="mt-4 text-right">
            <p-button 
                label="Send Remark" 
                variant="outlined" 
                icon="pi pi-send" 
                class="p-mt-3" 
                [raised]="true"
                (click)="sendRemark()">
            </p-button>
        </div>
    </div>
    

<!-- Boutons de navigation alignÃ©s -->
<div class="flex justify-content-between align-items-center mt-4">
    <!-- Espace pour aligner les boutons de validation et rejet -->
    <div class="flex gap-2">
        <p-button *ngIf="selectedSection?.nom !== 'Contact'"
            label="Approve" 
            severity="success" 
            class="p-mt-3" 
            (click)="validateSection(selectedSection._id)">
        </p-button>

        <p-button *ngIf="selectedSection?.nom !== 'Contact'"
            label="Reject" 
            severity="danger" 
            class="p-mt-3" 
            (click)="rejectSection(selectedSection._id)">
        </p-button>
    </div>

    <!-- Boutons Back et Next alignÃ©s Ã  droite -->
    <div class="flex gap-2">
        <p-button 
            label="Back" 
            class="p-button-secondary p-mt-3"
            [raised]="true"
            (click)="previousStep()" 
            *ngIf="activeIndex > 0">
        </p-button>

        <p-button 
            label="Next" 
            [disabled]="activeIndex >= sections.length - 1" 
            [raised]="true"
            class="p-button-info p-mt-3" 
            (click)="nextStep()">
        </p-button>
    </div>
</div>
<br>

  